LIST P = PIC18F4321 F= INHX32
    #include <p18f4321.inc>
    CONFIG OSC=HS
    CONFIG PBADEN=DIG 
    CONFIG WDT=OFF 
 
    ;VARIABLES
    Switch EQU 0x001
    FLAG EQU 0x002 
    PWM0H EQU 0x003
    PWM0L EQU 0x004
    PWM1H EQU 0x005
    PWM1L EQU 0x006
    PWM0HM EQU 0x0E
    PWM0LM EQU 0x0F
    PWM1HM EQU 0x010
    PWM1LM EQU 0x011
    Contador_1s EQU 0x007
    Contador_b1 EQU 0x0A
    Contador_b2 EQU 0x0B
    Adc_high EQU 0x0C
    Flash EQU 0x020
    Aux EQU 0x0D
    Carry EQU 0x012
    PWM_MOTOR1 EQU 0x013
    PWM_MOTOR0 EQU 0x014
    Switch2 EQU 0x015
    PUNTER_RAM EQU 0x016
    CONTADOR_RAM EQU 0x017
    VALOR_RAM_X EQU 0x019
    VALOR_RAM_Y EQU 0x01A
    MINUTOS EQU 0x01B
    SEGUNDOS EQU 0X01C
    VALOR_AUXILIAR EQU 0x01D
    CONTADOR_RAM_AUX EQU 0x01E
    LLEGIT_RAM_X  EQU 0x01F
    CONTADOR_1M EQU 0x031 ;0X035
    VALOR_ANTERIOR_X EQU 0x032
    VALOR_ANTERIOR_Y EQU 0x033
    MINUTOS_RAM EQU 0x034
    SEGUNDOS_RAM EQU 0X035
    EXTRA EQU 0x036
 
 
    ORG 0x0000
    GOTO INITS
    ORG 0x0008
    GOTO HIGH_RSI
    ORG 0x0018
    RETFIE FAST
    
    ORG Flash
     DB b'11001000', b'00001010' ;HIGH-MEDIUM
     DB b'01110010', b'00000010' ;LOW-ZERO
     DB .0, .1
     DB .2, .3
     DB .5, .5
     DB .6, .7
     DB .8, .9
	
    ;;;;;;;;;;;;;;;;;;;;;;;;INICIALITZACIONS;;;;;;;;;;;;;;;;;;;;;;
    ;Configure inputs & outputs
    INIT_PORTS
	;PUSH BUTTONS
	BSF TRISB,RB0,0
	BSF TRISB,RB1,0
	BSF TRISB,RB2,0
	
	;JOYSTICK
	BSF TRISA,AN0,0
	BSF TRISA,AN1,0
	
	;LED BIT 0 (RGB)
	BCF TRISB,RB3,0
	BCF LATB,RB3,0
	
	;LED BIT 1 (RGB)
	BCF TRISB,RB4,0
	BCF LATB,RB4,0
	
	;LED BIT 2 (RGB)
	BCF TRISB,RB6,0
	BCF LATB,RB6,0
	
	;SERVO MOTOR (PWM)
	BCF TRISE,RE2,0
	
	;PWM SPEED
	BCF TRISA,RA2,0
	BCF TRISA,RA5,0
	BCF LATA,2,0
	BCF LATA,5,0
	
	;ALARM LED
	BCF TRISA,RA3,0 
	BCF LATA,RA3,0
	
	;DEBUGGING
	BCF TRISA,RA4,0
	BCF LATA,RA4,0
	
	;CURRENT SPEED
	CLRF TRISD,0
	CLRF LATD,0
	
	;CURRENT DIRECTION
	CLRF TRISC,0
	CLRF LATC,0
	
	BCF TRISE,RE0,0
	BCF LATE,RE0,0
	BCF TRISE,RE1,0
	BCF LATE,RE1,0
	
	RETURN
    
    
    INIT_ADC
    
	;ADCON0
	MOVLW b'00000101' 
	MOVWF ADCON0, 0
	
	;ADCON1
	MOVLW b'00001101'
	MOVWF ADCON1,0
	
	;ADCON2
	CLRF ADCON2,0
	
	RETURN
	
    INIT_TIMER
	;T0CON
	MOVLW b'10001000' 
	MOVWF T0CON,0
	
	BCF Switch,3,0		; flag periode acabat
	MOVLW HIGH(.19261)
	MOVWF PWM0H,0
	MOVLW LOW(.19261)
	MOVWF PWM0L,0
	
	MOVLW HIGH(.61811)
	MOVWF PWM1H,0
	MOVLW LOW(.61811)
	MOVWF PWM1L,0
	
	MOVFF PWM0H, TMR0H
	MOVFF PWM0L, TMR0L
	
	RETURN
    
	
    INIT_VARS
    
	CLRF Switch,0
	CLRF FLAG,0
	CLRF Contador_1s,0
	CLRF Contador_b1,0
	CLRF Contador_b2,0
	CLRF Adc_high,0
	CLRF Aux,0
	CLRF Carry,0
	CLRF PWM_MOTOR1,0
	CLRF PWM_MOTOR0,0
	CLRF Switch2,0
	CLRF VALOR_RAM_X,0
	CLRF VALOR_RAM_Y,0
	CLRF PUNTER_RAM,0
	CLRF CONTADOR_RAM,0
	LFSR FSR0, 100h
	CLRF MINUTOS,0
	CLRF SEGUNDOS,0
	CLRF VALOR_AUXILIAR,0
	CLRF CONTADOR_RAM_AUX,0
	CLRF CONTADOR_1M,0
	CLRF VALOR_ANTERIOR_X,0
	CLRF VALOR_ANTERIOR_Y,0
	CLRF MINUTOS_RAM,0
	CLRF SEGUNDOS_RAM,0
	CLRF EXTRA,0
	
	RETURN
	
    INIT_INTERRUPTS
	BCF RCON, IPEN, 0
	;INTCON
	MOVLW b'11100000'
	MOVWF INTCON,0
	;INTCON2
	MOVLW b'01110101'
	MOVWF INTCON2,0
	;INTCON3
	MOVLW b'11000000'
	MOVWF INTCON3,0
	RETURN
    
    INIT_RAM
    
	LFSR FSR0,100h
	CLRF PUNTER_RAM, 0
	LOOP_RAM
	CLRF INDF0,0 
	INCF FSR0L,1,0
	INCF PUNTER_RAM,1,0
	MOVLW .20
	XORWF PUNTER_RAM,0
	BTFSS STATUS,Z,0
	GOTO LOOP_RAM
	LFSR FSR0, 100h
	CLRF PUNTER_RAM,0
	RETURN
    
    INITS
	CALL INIT_PORTS
	CALL INIT_ADC
	CALL INIT_INTERRUPTS
	CALL INIT_TIMER
	CALL INIT_VARS
	CALL INIT_RAM
	GOTO MAIN
	

    ;;;;;;;;;;;;;;;;;;;;;;;;;MANUAL MODE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    MANUAL_MODE
	;GREEN LED
	BCF LATB,RB3,0
	BSF LATB,RB4,0
	BCF LATB,RB6,0
	
	BCF Switch,0,0 
	BCF Switch2,7,0
	BCF Switch,2,0
	
	BTFSS FLAG,1,0
	GOTO MANUAL_MODE_RECORD
	ESPERO_RB1
	BTFSS PORTB,RB1,0
	GOTO ESPERO_RB1
	BCF FLAG,1,0

	MANUAL_MODE_RECORD
	BTFSC PORTB,RB0,0
	GOTO Auto_Record
	CALL BOUNCES
	ESPERO_MANUAL
	BTFSS PORTB,RB0,0
	GOTO ESPERO_MANUAL
	BCF Switch2,1,0   ; acabem d'apretar boto
	BTFSS Switch2,2,0 
	GOTO CRUISE_MODE
	BCF Switch2,2,0
	GOTO CRUISE_MODE

    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;JOYSTICK;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    
    JOYSTICK
	BSF ADCON0,ADON,0 ;convertidor a on
	BTFSC Switch,4,0
	GOTO X_AXIS
	GOTO Y_AXIS
    
    X_AXIS ;AN0 - DIRECCIÓ
    
        MOVFF LLEGIT_RAM_X, Adc_high
	BSF Switch,1,0	    ;eix x
	BTFSS Switch2,7,0 
	GOTO CONTINUO_X
	GOTO JS_SWITCH
	
	CONTINUO_X
	BCF ADCON0,CHS0,0
	BSF ADCON0,1,0
	WAIT_X
	BTFSC ADCON0,1,0
	GOTO WAIT_X
	MOVFF ADRESH,Adc_high
	BSF Switch,1,0
	GOTO JS_SWITCH
	
    
    Y_AXIS ;AN1 - SPEED
    
        MOVFF VALOR_AUXILIAR, Adc_high
	BCF Switch,1,0
	BTFSS Switch2,7,0 
	GOTO CONTINUO_Y
	GOTO JS_SWITCH
	
	CONTINUO_Y
	BTFSS Switch,0,0 ;CRUISE MODE 
	GOTO CONTINUO_Y2
	GOTO JS_SWITCH
	
	CONTINUO_Y2
	BSF ADCON0,CHS0,0
	BSF ADCON0,1,0
	WAIT_Y
	BTFSC ADCON0,1,0
	GOTO WAIT_Y
	MOVFF ADRESH,Adc_high
	BCF Switch,1,0
	MOVFF Adc_high, VALOR_AUXILIAR
	GOTO JS_SWITCH
    
    JS_SWITCH
	
	MOVLW .25
	CPFSGT Adc_high,0
	GOTO ARRAY_1
	
	MOVLW .50
	CPFSGT Adc_high,0
	GOTO ARRAY_2
	
	MOVLW .75
	CPFSGT Adc_high,0
	GOTO ARRAY_3
	
	MOVLW .100
	CPFSGT Adc_high,0
	GOTO ARRAY_4
	
	MOVLW .150
	CPFSGT Adc_high,0
	GOTO ARRAY_6
	
	MOVLW .175
	CPFSGT Adc_high,0
	GOTO ARRAY_7
	
	MOVLW .200
	CPFSGT Adc_high,0
	GOTO ARRAY_8
	
	MOVLW .225
	CPFSGT Adc_high,0
	GOTO ARRAY_9
	GOTO ARRAY_10
	
	
    RESETEJO_ALARMA
    BCF Switch2,1,0 
    BCF Switch2,2,0 
    RETURN
    
    ARRAY_1
	BTFSS Switch,1,0 ; 1 es X
	GOTO ARRAY_1Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP
	MOVLW .25
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'00000001'   ;array led
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
;	MOVLW .4	    ;servo motor
;	MOVWF Adc_high,0    ;servo motor
	GOTO TABLE	    ;servo motor
	
    ARRAY_1Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP1
        MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP1
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
        MOVLW .25
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .0 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .250
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BSF LATA,5,0
	BCF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
	
    ARRAY_2
	
	BTFSS Switch,1,0 ; 1 es X
	GOTO ARRAY_2Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP2
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP2
	MOVLW .50
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'00000010'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .5 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_2Y
    
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP3
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP3
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
	MOVLW .50
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .1 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .150
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BSF LATA,5,0
	BCF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_3

	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_3Y
	
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP4
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP4
	MOVLW .75
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'00000100'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .6 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_3Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP5
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP5
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
	MOVLW .75
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .1 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .150
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BSF LATA,5,0
	BCF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_4
       
	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_4Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP6
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP6
	MOVLW .100
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'00001000'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .7
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_4Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP7
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP7
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
	MOVLW .100
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .2 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .50
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BSF LATA,5,0
	BCF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_6
	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_6Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP8
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP8
	MOVLW .150
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'00110000'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .8 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_6Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP9
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP9
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
	MOVLW .150
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .3 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .0
	MOVWF PWM_MOTOR1
	MOVLW .0
	MOVWF PWM_MOTOR0
	BCF LATA,5,0
	BCF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
	
    ARRAY_7
     
	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_7Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP10
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP10
	MOVLW .175
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'01000000'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .9
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_7Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP11
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP11
	BTFSS Switch2,2,0 
	BCF LATA,RA3,0 
	MOVLW .175
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .2 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .50
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BCF LATA,5,0
	BSF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_8
       
	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_8Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP12
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP12
	MOVLW .200
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	MOVLW b'10000000'
	MOVWF LATC,0
	BCF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .10 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_8Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP13
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP13
	BTFSS Switch2,2,0 
	BSF LATA,RA3,0
	MOVLW .200
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .1 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .100
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BCF LATA,5,0
	BSF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_9
        
	BTFSS Switch,1,0 ; 1 es Y
	GOTO ARRAY_9Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP14
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP14
	MOVLW .225
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	CLRF LATC,0
	BSF LATE,0,0
	BCF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .11 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_9Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP15
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	AUTOP15
        BTFSS Switch2,2,0 
	BSF LATA,RA3,0
	MOVLW .225
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .1 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .200
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BCF LATA,5,0
	BSF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
    
    ARRAY_10

	BTFSS Switch,1,0 ; 1 es X, O ES Y
	GOTO ARRAY_10Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP16
	MOVF VALOR_ANTERIOR_X,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_X
	
	AUTOP16
	MOVLW .230
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_X,0
	CLRF LATC,0
	BCF LATE,0,0
	BSF LATE,1,0
	BTFSC FLAG,3,0
	GOTO BUCLE
	MOVLW .12 
	MOVWF EXTRA,0
	GOTO TABLE
	
    ARRAY_10Y
	BTFSC FLAG,3,0 ; Si és autopilot
	GOTO AUTOP17
	MOVF VALOR_ANTERIOR_Y,0
	CPFSEQ Adc_high,0
	CALL RESETEJO_ALARMA
	MOVFF Adc_high, VALOR_ANTERIOR_Y
	
	
	AUTOP17
	BTFSS Switch2,2,0 
	BSF LATA,RA3,0
	MOVLW .230
	BTFSC Switch2,4,0
	MOVWF VALOR_RAM_Y,0
	MOVLW .0 
	MOVWF EXTRA,0
	BTFSC FLAG,3,0
	GOTO TABLE
	BTFSC Switch2,0,0
	GOTO TABLE
	MOVLW .250
	MOVWF PWM_MOTOR1
	MOVLW .250
	MOVWF PWM_MOTOR0
	BCF LATA,5,0
	BSF LATA,2,0
	BSF Switch2,0,0
	GOTO TABLE
	
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;TABLE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    
    TABLE
    CLRF TBLPTRU,0
    CLRF TBLPTRH,0
    CLRF TBLPTRL,0
    MOVFF EXTRA, Aux
    MOVLW 0x020
    ADDWF Aux,1
    BTFSC STATUS,C,0 ; CARRY
    INCF TBLPTRH,1
    MOVFF Aux, TBLPTRL
    
    TBLRD*
    MOVFF TABLAT,Aux
    BTFSC Switch,1,0
    GOTO TABLE_X
    GOTO TABLE_Y
    
    ;;;;;;;;;;;;;GUARDAR RAM;;;;;;;;;;;;;;;;;;;;;
    
    SAVE_RAM
    
    BSF FLAG,0,0	; Save flag 
    BCF Switch2,1,0	; Recording - activity
   
    ;;;;;;;;;;MINUTOS
    MOVFF MINUTOS_RAM, INDF0
    INCF FSR0L,1,0
    INCF PUNTER_RAM,1,0
    
    ;;;;;;;;;;;SEGUNDOS
    MOVFF SEGUNDOS_RAM, INDF0
    INCF FSR0L,1,0
    INCF PUNTER_RAM,1,0
    
    ;;;;;;;;;;;;EIX X
    MOVFF VALOR_RAM_X, INDF0
    INCF FSR0L,1,0
    INCF PUNTER_RAM,1,0
    
    ;;;;;;;;;;;;EIX Y
    MOVFF VALOR_RAM_Y, INDF0
    INCF FSR0L,1,0
    INCF PUNTER_RAM,1,0
    
    CLRF MINUTOS_RAM,0
    CLRF SEGUNDOS_RAM,0
    MOVFF PUNTER_RAM, CONTADOR_RAM
    MOVLW .120
    XORWF PUNTER_RAM,0
    BTFSC STATUS,Z,0 
    GOTO NEXTT
    MOVFF CONTADOR_RAM, PUNTER_RAM
    RETURN
    
    NEXTT
    BSF Switch2,5,0
    RETURN
    
    TABLE_X ;SERVO
    
;	MOVLW HIGH(.16786)
;	MOVWF PWM0HM,0
;	MOVLW LOW(.16786)
;	MOVWF PWM0LM,0
;	
;	MOVLW HIGH(.64286)
;	MOVWF PWM1HM,0
;	MOVLW LOW(.64286)
;	MOVWF PWM1LM,0
;	
;	LOOP_AUX
;	MOVLW .0
;	CPFSEQ Aux, 0
;	GOTO CONTINUE
;	MOVFF PWM0LM, PWM0L
;	MOVFF PWM0HM, PWM0H
;	MOVFF PWM1LM, PWM1L
;	MOVFF PWM1HM, PWM1H
	BTFSC FLAG,3,0  ;autopilot   ;BTFSC Switch2,7,0
	GOTO BUCLE
	BTFSC Switch,0,0
	GOTO CRUISE_MODE_BOTO
	BTFSS Switch2,4,0
	GOTO MANUAL_MODE
	GOTO RECORD1
	
;	CONTINUE
;	MOVFF PWM0LM, Carry
;	MOVLW HIGH(.495)
;	ADDWF PWM0HM, 1,0
;	MOVLW LOW(.495)
;	ADDWF Carry,1,0
;	BTFSC STATUS,Carry,0
;	INCF PWM0HM,1,0
;	MOVFF Carry,PWM0LM
;	
;	MOVFF PWM1LM, Carry
;	MOVLW HIGH(.495)
;	SUBWF PWM1HM, 1,0
;	MOVLW LOW(.495)
;	SUBWF Carry,1,0
;	BTFSS STATUS,Carry,0
;	DECF PWM1HM,1,0
;	MOVFF Carry,PWM1LM
;	
;	DECF Aux,1,0 ;????'
;	GOTO LOOP_AUX

    
    TABLE_Y ;MOTOR
    MOVFF Aux,LATD
    BTFSC FLAG,3,0  ;autopilot   ;BTFSC Switch2,7,0
    GOTO BUCLE
;    MOVFF Aux,LATD
    BTFSC Switch,0,0
    GOTO CRUISE_MODE_BOTO
    BTFSS Switch2,4,0
    GOTO MANUAL_MODE
    GOTO RECORD1
    
	
    Auto_Record
	
	BTFSC PORTB,RB1,0
	GOTO JOYSTICK
	BSF LATA,RA4,0
        CALL BOUNCES
	LOOP1
	BTFSS PORTB,RB1,0
	GOTO LOOP2		; while not pressed, loop
	LOOP3
;	BSF LATA,RA3,0
	BCF Switch2,1,0		; button just pressed, activity
	BCF Switch,6,0		; clear a complete timer period
	BCF Switch,5,0		; clear half-timer period
	CLRF Contador_1s,0
	BTFSC FLAG,0,0		;hem guardat algo
	GOTO AUTO
	GOTO AUTO2
	
	AUTO2
	BTFSC Switch,2,0	; ha passat un segon?
	GOTO FIRST_TIME
	GOTO RECORD_MODE
	
	FIRST_TIME
	BSF FLAG,1,0
	GOTO MANUAL_MODE
	
	AUTO
	BTFSC Switch,2,0	; ha passat un segon?
	GOTO AUTOPILOT_MODE
	GOTO RECORD_MODE
	
    ;20ms * 50 = 1000 ms
    ;20ms * 300 = 60000 ms
	
    LOOP2
	BTFSS Switch,6,0 ;Volta al timer
	GOTO LOOP1
	BCF Switch,6,0
	BCF Switch,5,0
	INCF Contador_1s,1,0
	MOVLW .5 ;50
	SUBWF Contador_1s,1,0  
	BTFSS STATUS,Z,0
	GOTO LOOP1
	BSF Switch,2,0   ; ha passat un segon
	GOTO LOOP3
	
;    LOOP5
;	BTFSS Switch,6,0 ;Volta al timer
;	GOTO LOOP4
;	BCF Switch,6,0
;	BCF Switch,5,0
;	INCF CONTADOR_1M,1,0
;	MOVLW .300
;	SUBWF CONTADOR_1M,1,0  ;CPFSEQ Contador_1s,0
;	BTFSS STATUS,Z,0
;	GOTO LOOP4
;	BSF FLAG,2,0   ; ha passat un minut
;	GOTO LOOP6
	
    BOUNCES
    MOVLW 0xFF
    MOVWF Contador_b1, 0
    
    REPETITION1
	MOVLW .194
	MOVWF Contador_b2, 0
    REPETITION2
	DECFSZ Contador_b2,1
	GOTO REPETITION2
	DECFSZ Contador_b1,1
	GOTO REPETITION1
	NOP
	NOP
    RETURN 
	
	
    CRUISE_MODE
	;BLUE LED
	BCF LATB,RB3,0
	BCF LATB,RB4,0
	BSF LATB,RB6,0
	
	BSF Switch,0,0
	GOTO JOYSTICK

	CRUISE_MODE_BOTO
	BTFSC PORTB,RB0,0
	GOTO CRUISE_MODE
	CALL BOUNCES
	ESPERO_CRUISE
	BTFSS PORTB,RB0,0
	GOTO ESPERO_CRUISE
	BCF Switch2,1,0 ;acaba d'apretar un boto
	BTFSS Switch2,2,0 
	GOTO MANUAL_MODE
	BCF Switch2,2,0
	GOTO MANUAL_MODE
	
    RECORD_MODE
   
	BCF Switch2,1,0	 ;activitat
        BSF FLAG,2,0 ; no hem apretat al boto de save
        CALL INIT_RAM
	;RED LED
	BSF LATB,RB3,0
	BCF LATB,RB4,0
	BCF LATB,RB6,0
	
	BCF Switch2,5,0	    ; Clear to be able to save
	
	RECORD_JOYSTICK
	BSF Switch2,4,0
	GOTO JOYSTICK

	RECORD1
	BTFSC PORTB,RB1,0
	GOTO RECORD
	CALL BOUNCES
	ESPERO_RECORD
	BTFSS PORTB,RB1,0
	GOTO ESPERO_RECORD
	BCF Switch2,1,0	    ; button just pressed - activity
	BCF Switch2,4,0
	GOTO MANUAL_MODE
	
	RECORD
	CALL COMPROBO_SAVE
	BTFSS Switch2,5,0
	GOTO RECORD_JOYSTICK
	BCF FLAG,1,0
	BCF Switch2,4,0
	GOTO MANUAL_MODE
	
	COMPROBO_SAVE
	BTFSC PORTB,RB2,0
	RETURN
	CALL BOUNCES
	ESPERO_SAVE
	BTFSS PORTB,RB2,0
	GOTO ESPERO_SAVE
	BCF FLAG,2,0 ; hem apretat boto save
	BCF Switch2,1,0      ; button just pressed - activity
	BTFSS Switch2,2,0 
	GOTO MENU
	BCF Switch2,2,0
	MENU
	CALL SAVE_RAM
	RETURN
	
    AUTOPILOT_MODE
	;WHITE LED
	BSF LATB,RB3,0
	BSF LATB,RB4,0
	BSF LATB,RB6,0
	
	BSF FLAG,3,0 ;ESTIC A AUTOPILOT	
	;BCF Switch,3,0
	BSF Switch2,7,0
	BCF Switch2,4,0
;	BCF Switch2,1,0 ;estem posant tota la grabació, activitat
;	BTFSS Switch2,2,0 
;	GOTO AUTOPILOT_C
;	BCF Switch2,2,0
	
	AUTOPILOT_C
	LFSR FSR0,100h
	;CLRF PUNTER_RAM, 0
	CLRF CONTADOR_RAM_AUX, 0

	BUCLE
	BSF Switch,7,0
	
	;;;;;;;;;;MINUTOS
	MOVFF INDF0, MINUTOS
	INCF FSR0L,1,0
	INCF CONTADOR_RAM_AUX,1,0
	
	;;;;;;;;;;SEGONS
	MOVFF INDF0, SEGUNDOS
	INCF FSR0L,1,0
	INCF CONTADOR_RAM_AUX,1,0
	
	ESPERO_GEN
	BTFSC Switch,7,0
	GOTO ESPERO_GEN

	;;;;;;;;;;;;EIX X;;;;;;;;;;;
	MOVFF INDF0, LLEGIT_RAM_X
	INCF FSR0L,1,0
	INCF CONTADOR_RAM_AUX,1,0

	;;;;;;;;;;;;EIX Y
	MOVFF INDF0, VALOR_AUXILIAR
	INCF FSR0L,1,0
	INCF CONTADOR_RAM_AUX,1,0
	
	MOVLW .16
	CPFSEQ CONTADOR_RAM_AUX,0
	GOTO JOYSTICK
	BCF FLAG,3,0
	GOTO MANUAL_MODE
	
;	MOVF CONTADOR_RAM_AUX,0
;	XORWF CONTADOR_RAM,0
;	BTFSC STATUS,Z,0
;	GOTO REINICI
	
;	    MOVFF CONTADOR_RAM_AUX, CONTADOR_RAM
;	    MOVF PUNTER_RAM
;	    XORWF CONTADOR_RAM_AUX,0
;	    BTFSC STATUS,Z,0 
;	    GOTO REINICI
;	    MOVFF CONTADOR_RAM, CONTADOR_RAM_AUX
	
	;goto  AUTOPILOT_MODE
	
	GOTO JOYSTICK
	
	;REINICI
	    ;LFSR FSR0,100h
	    ;CLRF PUNTER_RAM, 0
	    ;CLRF CONTADOR_RAM_AUX, 0
	    
	;GOTO MANUAL_MODE

	
    
    HIGH_RSI
	BCF INTCON,TMR0IF,0
	BTFSS Switch,4,0
	GOTO PWM1
	GOTO PWM0
	 
    
    PWM1
	MOVFF PWM1H, TMR0H
	MOVFF PWM1L, TMR0L
	BSF LATE,RE2,0
	BSF Switch,4,0
	BSF Switch,5,0
	GOTO PWM_VELO_C
		
    PWM0
	MOVFF PWM0H, TMR0H
	MOVFF PWM0L, TMR0L
	BCF LATE,RE2,0
	BCF Switch,4,0
	BTFSC Switch,5,0
	BSF Switch,6,0

	PWM_VELO_C
	BTFSS Switch,6,0   ;UNA VOLTA
	RETFIE FAST
	
;	BTFSS Switch2,4,0 ; record MODE
;	GOTO SEGUEIX
;	BSF LATA,RA4,0
;	BTFSS FLAG,2,0 ; NO HEM APRETAT 
;	GOTO APRETAT
;	INCF CONTADOR_1M,1,0
;	MOVLW .300
;	SUBWF CONTADOR_1M,1,0  
;	BTFSS STATUS,Z,0
;	GOTO SEGUEIX
;	BSF FLAG,3,0   ; ha passat un minut
;	GOTO SEGUEIX
;	
;	APRETAT
;	BCF Switch,5,0
;	BCF Switch,6,0
;	CLRF CONTADOR_1M,0
;	GOTO SEGUEIX
;	
;	SEGUEIX
	BTFSC Switch,7,0
	CALL TEMPS_RAM
	BTFSC Switch,7,0
	GOTO SALTO
	BTFSS Switch2,1,0 ;inactivitat
	CALL NO_MINUTO
	CALL MINUTO
	
	SALTO
	;BCF Switch,7,0
	MOVLW .0
	CPFSGT PWM_MOTOR1,0
	GOTO DECREMENTAR_ZERO
	DECF PWM_MOTOR1,1,0
	RETFIE FAST
	
	DECREMENTAR_ZERO
	BCF LATA,5,0
	BCF LATA,2,0
	MOVLW .0
	CPFSGT PWM_MOTOR0,0
	GOTO ACABAR
	DECF PWM_MOTOR0,1,0
	RETFIE FAST
	
	ACABAR
	BCF Switch2,0,0
	RETFIE FAST
	
	
    NO_MINUTO
    CLRF SEGUNDOS,0
    CLRF MINUTOS,0
    BSF Switch2,1,0  ;inactivitat
    RETURN
    
    MINUTO
    BTFSC Switch2,2,0 ; per alarma o no
    GOTO ALARMA_ON
    
    BTFSS Switch2,4,0
    GOTO ALARMA_C
    MOVLW .60
    CPFSEQ MINUTOS_RAM,0
    CALL CONTINUO_SEGUNDOS_RAM
    
    ALARMA_C
    MOVLW .60
    CPFSEQ MINUTOS,0
    GOTO CONTINUO_SEGUNDOS
    GOTO ALARMA_ACT
    
    CONTINUO_SEGUNDOS_RAM
    MOVLW .100		    ;50
    SUBWF SEGUNDOS_RAM,0,0
    BTFSS STATUS,Z,0
    GOTO INCREMENTO_SEGUNDOS_RAM
    INCF MINUTOS_RAM,1,0
    CLRF SEGUNDOS_RAM,0
    RETURN
    
    CONTINUO_SEGUNDOS
    MOVLW .100		    ;50
    SUBWF SEGUNDOS,0,0
    BTFSS STATUS,Z,0
    GOTO INCREMENTO_SEGUNDOS
    INCF MINUTOS,1,0
    CLRF SEGUNDOS,0
    RETURN
    
    INCREMENTO_SEGUNDOS
    INCF SEGUNDOS,1,0
    RETURN
    
    INCREMENTO_SEGUNDOS_RAM
    INCF SEGUNDOS_RAM,1,0
    RETURN
    
    DECREMENTO_SEGUNDOS
    DECF SEGUNDOS,1,0
    RETURN

    
;    TEMPS_RAM
;    MOVLW .0
;    CPFSEQ MINUTOS,0
;    GOTO CONTINUO_SEGUNDOS1
;    BCF Switch,7,0
;    RETURN
;    
;    CONTINUO_SEGUNDOS1
;    MOVLW .0
;    SUBWF SEGUNDOS,0,0
;    BTFSS STATUS,Z,0
;    GOTO DECREMENTO_SEGUNDOS
;    DECF MINUTOS,1,0
;    CLRF SEGUNDOS,0
;    RETURN
    
    
    TEMPS_RAM
    MOVLW .0
    CPFSEQ SEGUNDOS,0
    GOTO CONTINUO_SEGUNDOS1
    MOVLW .0
    SUBWF MINUTOS,0,0
    BTFSC STATUS,Z,0
    GOTO FI_LECTURA
    DECF MINUTOS,1,0
    MOVLW .59
    MOVWF SEGUNDOS,0
    RETURN
    
    CONTINUO_SEGUNDOS1
    DECF SEGUNDOS,1,0
    RETURN
    
    FI_LECTURA
    BCF Switch,7,0
    RETURN
    
    
    ALARMA_ON
    MOVLW .50
    SUBWF SEGUNDOS,0,0
    BTFSS STATUS,Z,0
    GOTO INCREMENTO_SEGUNDOS
    INCF MINUTOS,1,0
    CLRF SEGUNDOS,0
    BTG LATA,RA3,0
    
    RETURN
    
    ALARMA_ACT
    CLRF SEGUNDOS,0
    CLRF MINUTOS,0
    BSF Switch2,2,0
    BSF LATA,RA3,0
    RETURN
    
    MAIN
    GOTO MANUAL_MODE
    END

   